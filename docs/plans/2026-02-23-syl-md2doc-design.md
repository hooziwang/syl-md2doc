# syl-md2doc 设计文档

**日期**: 2026-02-23  
**状态**: 已确认

## 1. 目标与边界

`syl-md2doc` 是一个 Go 命令行程序，用于将一个或多个 Markdown 文件批量转换为 Word (`.docx`)。

边界约束：
- 支持输入多个文件、多个目录、以及文件与目录混合输入。
- 仅处理 `.md` 文件。
- 一个 `.md` 文件对应一个 `.docx` 文件。
- Markdown 支持范围为 `CommonMark + GFM`。
- 首版转换后端使用外部 `pandoc`（要求用户预先安装）。
- 不提供 YAML 配置系统，全部通过命令行参数控制。

## 2. CLI 设计

支持两种等价入口：
1. `syl-md2doc [inputs...] [--output ...] [--jobs ...] [--reference-docx ...]`
2. `syl-md2doc build [inputs...] [--output ...] [--jobs ...] [--reference-docx ...]`

额外命令：
- `syl-md2doc version`

不提供：
- `check` 子命令

### 2.1 参数语义

- `inputs...`：至少一个输入，支持文件与目录混合。
- `--output, -o`：输出目标，兼容目录/文件语义。
  - 单输入时：可指向目录或文件。
  - 多输入时：若传入文件路径，自动退化为目录模式使用其父目录，并输出警告。
  - 未提供时：默认当前目录。
- `--jobs, -j`：并发 worker 数，默认 `runtime.NumCPU()`。
- `--reference-docx`：可选，传给 pandoc 作为样式模板。
- `--pandoc-path`：可选，指定 pandoc 可执行路径；默认使用 `pandoc`。
- `--verbose`：可选，打印每个任务明细。

## 3. 输入发现与输出规划

## 3.1 输入扫描

- 目录输入：递归扫描全部子目录。
- 文件输入：仅接受 `.md`。
- 非 `.md` 文件：忽略并记录 `warn`。
- 输入不存在：标记为失败项，但不阻断批次执行。

## 3.2 输出路径规划

- 目录输入来源的文件：保留“相对该目录根”的子路径输出。
- 单独文件输入：输出到输出根目录。
- 目标扩展名固定为 `.docx`。
- 输出目录不存在时自动创建。

## 3.3 命名冲突

- 若目标文件名冲突，自动追加后缀 `_1`, `_2`, ...，不覆盖已有文件。

## 4. 转换后端与容错策略

## 4.1 转换后端

- 使用外部 `pandoc` 执行转换。
- 需要在启动阶段检测可执行文件可用性。
- 支持 `--pandoc-path` 覆盖默认查找路径。

## 4.2 缺失资源与错误处理

- 本地图片资源缺失：仅告警，继续转换该文件（遵循用户决策）。
- 单文件转换失败：记录失败并继续处理其它文件。
- 批次结束后：输出失败清单并返回非 0。

## 5. 并发与执行模型

- 采用 worker pool。
- 默认并发度为 CPU 核数。
- 支持 `--jobs` 显式覆盖。
- 结果通过线程安全汇总器收集：成功、失败、告警。

## 6. 输出与退出码

- 控制台输出保持简洁、可 grep。
- 汇总信息包括：
  - 成功数量
  - 失败数量
  - 告警数量
  - 失败项列表（源文件 + 错误）
- 退出码规则：
  - 失败数 > 0：退出码 1
  - 失败数 = 0：退出码 0

## 7. 工程复用点（对齐 syl-md2ppt）

与 `syl-md2ppt` 对齐的基础能力：
- Cobra 命令结构与直跑归一化（默认转成 `build`）。
- 明确的参数校验与中文错误信息。
- 输出路径解析和默认输出目录策略。
- 简洁稳定的警告/错误输出风格。
- 分层结构：`cmd -> app/runner -> domain modules`。

## 8. 非目标

首版不包含以下能力：
- 纯 Go 的 markdown->docx 渲染器。
- YAML 配置文件及自动发现加载。
- `check` 子命令。
- 复杂样式 DSL（仅支持 `--reference-docx` 模板）。

